<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <title>☀️ Climats - Previsão do Tempo</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap"
        rel="stylesheet"
    />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    />

    <style>
        /* 1. Variáveis CSS Customizadas (Root) */
        :root {
            /* Cores */
            --primary-color: #594cee;
            --secondary-color: #8dd0f5;
            --background-gradient: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --container-bg-color: rgba(92, 84, 237, 0.9);
            --text-color: #fdfdfd;
            --input-bg-color: rgba(255, 255, 255, 0.9);
            --button-color: var(--secondary-color);
            --error-color: #ffcccc;

            /* Espaçamento e Borda */
            --spacing-unit: 1rem;
            --container-padding: 2rem;
            --border-radius-base: 8px;
            --border-radius-large: 1.5rem;

            /* Transições */
            --transition-speed: 0.3s;
        }

        /* 2. Reset e Configurações Básicas */
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            font-family: "Ubuntu", sans-serif;
        }

        body {
            background: var(--background-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-unit);
            transition: background-image 0.5s ease;
            background-size: cover;
            background-position: center;
        }

        /* Melhoria de Acessibilidade: Desabilitar transições para usuários que preferem menos movimento */
        @media (prefers-reduced-motion: reduce) {
            body {
                transition: none;
            }
            .form-input-container button,
            .history-item {
                transition: none !important;
            }
        }

        .hide {
            display: none !important;
        }

        /* 3. Container Principal */
        .container {
            background-color: var(--container-bg-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: var(--container-padding);
            color: var(--text-color);
            border-radius: var(--border-radius-large);
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }

        /* 4. Cabeçalho */
        .app-header {
            text-align: center;
            margin-bottom: var(--container-padding);
        }

        .app-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* 5. Formulário de Busca */
        .search-form {
            margin-bottom: var(--container-padding);
        }

        .search-form h3 {
            margin-bottom: var(--spacing-unit);
            font-weight: 500;
        }

        .form-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .form-input-container input {
            padding: 0.8rem 1rem;
            border: none;
            flex: 1;
            border-radius: var(--border-radius-base);
            font-size: 1rem;
            background: var(--input-bg-color);
            transition: all var(--transition-speed) ease;
        }

        .form-input-container input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--secondary-color);
            background: white;
        }

        .form-input-container button {
            padding: 0.8rem 1.2rem;
            background-color: var(--button-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius-base);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-input-container button:hover {
            background-color: #7bc0e5; /* Um tom ligeiramente mais escuro de secondary-color */
            transform: translateY(-2px);
        }

        .form-input-container button:active {
            transform: translateY(0);
        }

        /* 6. Indicador de Carregamento */
        .loader {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--text-color);
            animation: spin 1s ease-in-out infinite;
            margin: var(--spacing-unit) auto;
            /* Acessibilidade: Evitar animação para quem não quer */
            animation-play-state: running;
        }
        @media (prefers-reduced-motion: reduce) {
            .loader {
                animation: none;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 7. Dados do Clima */
        #weather-data {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #weather-data h2 {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.8rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        #weather-data h2 i {
            font-size: 1rem;
        }

        #temperature {
            font-size: 3rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        #description-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: var(--spacing-unit) 0;
            gap: 0.5rem;
        }

        #description {
            font-weight: bold;
            text-transform: capitalize;
            font-size: 1.2rem;
        }

        #weather-icon {
            width: 60px;
            height: 60px;
        }

        #details-container {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem; /* Adicionado um gap para melhor espaçamento em telas menores */
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.8rem;
            /* Adicionado min-width para garantir que os itens não fiquem muito pequenos */
            min-width: 80px;
        }

        .detail-item i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .detail-item span {
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 0.3rem;
        }

        /* 8. Mensagens de Erro */
        .error-message {
            background-color: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: var(--error-color);
            padding: 0.8rem;
            border-radius: var(--border-radius-base);
            margin-top: var(--spacing-unit);
            text-align: center;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 9. Histórico de Buscas */
        .search-history {
            margin-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: var(--spacing-unit);
        }

        .search-history h3 {
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            white-space: nowrap; /* Impede quebras de linha dentro do item */
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* 10. Responsividade */
        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
            }
            
            #temperature {
                font-size: 2.5rem;
            }
            
            .form-input-container {
                flex-direction: column;
            }
            
            .form-input-container button {
                margin-top: 0.5rem;
            }

            .detail-item {
                flex: 1 1 45%; /* Permite 2 itens por linha */
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <main class="container" role="main">
        <header class="app-header">
            <h1><i class="fa-solid fa-cloud-sun" aria-hidden="true"></i> Climats</h1>
            <p>Previsão do tempo em tempo real</p>
        </header>
        
        <section class="search-form" aria-labelledby="search-heading">
            <h3 id="search-heading">Confira o clima de uma cidade:</h3>
            <div class="form-input-container">
                <label for="city-input" class="hide-visually">Digite o nome da cidade</label>
                <input 
                    type="text" 
                    placeholder="Digite o nome da cidade*" 
                    id="city-input"
                    aria-required="true"
                    aria-describedby="search-heading"
                />
                <button id="search" aria-label="Buscar clima da cidade digitada">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                </button>
            </div>
        </section>
        
        <div id="loader" class="loader hide" role="status" aria-label="Carregando dados do clima"></div>
        
        <div id="error-message" class="error-message hide" role="alert"></div>
        
        <section id="weather-data" class="hide" aria-live="polite">
            <h2 id="city-name-location">
                <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
                <span id="city"></span>
                <img crossorigin="anonymous" src="" id="country" alt="Bandeira do país">
            </h2>
            <p id="temperature"><span aria-label="Temperatura atual"></span>&deg;C</p>
            <div id="description-container">
                <p id="description" role="status"></p>
                <img crossorigin="anonymous" src="" id="weather-icon" alt="Ícone de condição climática">
            </div>
            <div id="details-container">
                <div class="detail-item" role="group" aria-label="Detalhe da Umidade">
                    <i class="fa-solid fa-droplet" aria-hidden="true"></i>
                    <span>Umidade</span>
                    <div id="humidity" class="detail-value"></div>
                </div>
                <div class="detail-item" role="group" aria-label="Detalhe do Vento">
                    <i class="fa-solid fa-wind" aria-hidden="true"></i>
                    <span>Vento</span>
                    <div id="wind" class="detail-value"></div>
                </div>
                <div class="detail-item" role="group" aria-label="Detalhe da Sensação Térmica">
                    <i class="fa-solid fa-temperature-high" aria-hidden="true"></i>
                    <span>Sensação</span>
                    <div id="feels-like" class="detail-value"></div>
                </div>
            </div>
        </section>
        
        <section id="search-history" class="search-history hide" aria-labelledby="history-heading">
            <h3 id="history-heading">Buscas recentes:</h3>
            <div class="history-list" id="history-list" role="list"></div>
        </section>
    </main>

    <script>
        // IIFE para isolar o escopo do script
        (function() {
            "use strict";

            // 1. Configurações e Chaves da API
            const apiKey = "378bc93c3980714a7cddb245cd56420f";
            const apiCountryURL = "https://countryflagsapi.com/png/";
            const apiUnsplash = "https://source.unsplash.com/1600x900/?";
            const apiWeatherBaseURL = "https://api.openweathermap.org/data/2.5/weather";

            // 2. Elementos DOM (Cache de Referências)
            const cityInput = document.getElementById("city-input");
            const searchBtn = document.getElementById("search");
            const cityElement = document.getElementById("city");
            const tempElement = document.getElementById("temperature").querySelector("span");
            const descElement = document.getElementById("description");
            const weatherIconElement = document.getElementById("weather-icon");
            const countryElement = document.getElementById("country");
            const humidityElement = document.getElementById("humidity");
            const windElement = document.getElementById("wind");
            const feelsLikeElement = document.getElementById("feels-like");
            const weatherContainer = document.getElementById("weather-data");
            const loader = document.getElementById("loader");
            const errorMessage = document.getElementById("error-message");
            const searchHistorySection = document.getElementById("search-history");
            const historyList = document.getElementById("history-list");
            const body = document.body;

            // 3. Histórico de Buscas (Persistência)
            let searchHistoryData = JSON.parse(localStorage.getItem("weatherSearchHistory")) || [];
            const MAX_HISTORY_ITEMS = 5;

            // 4. Funções Utilitárias para Estado da Interface
            const toggleLoader = (show) => {
                loader.classList.toggle("hide", !show);
            };

            const toggleWeatherDisplay = (show) => {
                weatherContainer.classList.toggle("hide", !show);
            };

            const showError = (message) => {
                errorMessage.innerText = message;
                errorMessage.classList.remove("hide");
            };

            const clearError = () => {
                errorMessage.classList.add("hide");
                errorMessage.innerText = "";
            };

            // 5. Função de Requisição da API
            const getWeatherData = async (city) => {
                const apiWeatherURL = `${apiWeatherBaseURL}?q=${city}&units=metric&appid=${apiKey}&lang=pt_br`;

                try {
                    const res = await fetch(apiWeatherURL);
                    
                    if (!res.ok) {
                        if (res.status === 404) {
                            throw new Error("Cidade não encontrada. Verifique o nome e tente novamente.");
                        }
                        throw new Error(`Erro de rede: ${res.status}`);
                    }
                    
                    const data = await res.json();
                    return data;
                } catch (error) {
                    console.error("Erro ao buscar dados do clima:", error);
                    throw error;
                }
            };

            // 6. Função Principal para Exibir Dados
            const showWeatherData = async (city) => {
                const sanitizedCity = city.trim();
                
                if (!sanitizedCity) return;

                clearError();
                toggleWeatherDisplay(false);
                toggleLoader(true);
                
                try {
                    const data = await getWeatherData(sanitizedCity);
                    
                    // Atualizar elementos com os dados
                    cityElement.innerText = data.name;
                    tempElement.innerText = Math.round(data.main.temp);
                    descElement.innerText = data.weather[0].description;
                    weatherIconElement.setAttribute(
                        "src",
                        `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`
                    );
                    weatherIconElement.setAttribute("alt", `Ícone: ${data.weather[0].description}`);
                    countryElement.setAttribute("src", apiCountryURL + data.sys.country);
                    countryElement.setAttribute("alt", `Bandeira: ${data.sys.country}`);
                    humidityElement.innerText = `${data.main.humidity}%`;
                    windElement.innerText = `${data.wind.speed.toFixed(1)} km/h`; // Melhor formatação para o vento
                    feelsLikeElement.innerText = `${Math.round(data.main.feels_like)}°C`;
                    
                    // Atualizar imagem de fundo
                    body.style.backgroundImage = `url("${apiUnsplash + sanitizedCity + ' weather'}")`;
                    
                    // Adicionar ao histórico e atualizar a exibição
                    addToHistory(sanitizedCity);
                    
                    // Esconder loader e mostrar dados
                    toggleLoader(false);
                    toggleWeatherDisplay(true);
                    cityInput.value = ""; // Limpar campo de entrada após sucesso

                } catch (error) {
                    toggleLoader(false);
                    showError(error.message || "Ocorreu um erro ao buscar o clima.");
                    // Resetar para o fundo padrão em caso de erro
                    body.style.backgroundImage = "var(--background-gradient)"; 
                }
            };

            // 7. Funções de Histórico
            const addToHistory = (city) => {
                const normalizedCity = city.toLowerCase();

                // Remover duplicatas
                searchHistoryData = searchHistoryData.filter(item => item.toLowerCase() !== normalizedCity);
                
                // Adicionar no início do array
                searchHistoryData.unshift(city);
                
                // Manter apenas o máximo de buscas
                if (searchHistoryData.length > MAX_HISTORY_ITEMS) {
                    searchHistoryData.length = MAX_HISTORY_ITEMS;
                }
                
                // Salvar no localStorage
                localStorage.setItem("weatherSearchHistory", JSON.stringify(searchHistoryData));
                
                // Atualizar exibição do histórico
                updateHistoryDisplay();
            };

            const updateHistoryDisplay = () => {
                if (searchHistoryData.length > 0) {
                    historyList.innerHTML = "";
                    searchHistoryData.forEach((city, index) => {
                        const historyItem = document.createElement("div");
                        historyItem.classList.add("history-item");
                        historyItem.setAttribute("role", "listitem");
                        historyItem.setAttribute("tabindex", "0"); // Torna o item focável
                        historyItem.innerText = city;

                        // Reutilizar o showWeatherData ao clicar/teclar Enter
                        const handleHistoryClick = () => {
                             // Não limpar o input, apenas usá-lo para a busca
                            showWeatherData(city);
                        };
                        historyItem.addEventListener("click", handleHistoryClick);
                        historyItem.addEventListener("keyup", (e) => {
                            if (e.code === "Enter" || e.code === "Space") {
                                handleHistoryClick();
                            }
                        });

                        historyList.appendChild(historyItem);
                    });
                    searchHistorySection.classList.remove("hide");
                } else {
                    searchHistorySection.classList.add("hide");
                }
            };

            // 8. Validação de Entrada
            const validateInput = (city) => {
                if (!city.trim()) {
                    showError("Por favor, digite o nome de uma cidade");
                    return false;
                }
                return true;
            };

            // 9. Event Listeners
            const handleSearch = (cityValue) => {
                const city = cityValue.trim();
                
                if (validateInput(city)) {
                    showWeatherData(city);
                }
            };

            searchBtn.addEventListener("click", (e) => {
                e.preventDefault();
                handleSearch(cityInput.value);
            });

            cityInput.addEventListener("keyup", (e) => {
                if (e.code === "Enter") {
                    handleSearch(e.target.value);
                }
            });

            // 10. Inicialização
            const initializeApp = () => {
                updateHistoryDisplay();
                
                // Tentar buscar clima da localização do usuário
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            try {
                                const { latitude, longitude } = position.coords;
                                // Requisição usando lat/lon
                                const apiWeatherURL = `${apiWeatherBaseURL}?lat=${latitude}&lon=${longitude}&units=metric&appid=${apiKey}&lang=pt_br`;
                                
                                const res = await fetch(apiWeatherURL);
                                const data = await res.json();
                                
                                // Inicia a aplicação exibindo o clima da localização
                                showWeatherData(data.name);

                            } catch (error) {
                                console.log("Não foi possível obter a localização automática. Digite uma cidade.");
                                toggleLoader(false); // Garantir que o loader esteja oculto se falhar
                            }
                        },
                        (error) => {
                            console.log("Permissão de localização negada ou indisponível. Digite uma cidade.");
                            toggleLoader(false);
                            toggleWeatherDisplay(false);
                        },
                        {
                            enableHighAccuracy: false, // Não requer alta precisão para economia de bateria
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    console.log("Geolocalização não suportada pelo navegador.");
                    toggleLoader(false);
                    toggleWeatherDisplay(false);
                }
            };

            initializeApp();
        })();
    </script>
</body>
</html>
